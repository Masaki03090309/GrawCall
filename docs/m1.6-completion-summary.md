# M1.6 完了レポート: プロジェクト・ユーザー管理

**完了日**: 2025-11-03
**マイルストーン**: M1.6 - プロジェクト・ユーザー管理
**ステータス**: ✅ 完了

---

## 実装概要

M1.6では、プロジェクトとユーザーの管理機能を実装しました。これにより、システム全体のマルチテナント対応とロールベースアクセス制御（RBAC）が完成しました。

### 実装した機能

1. **プロジェクト管理**
   - プロジェクト一覧表示
   - プロジェクト作成
   - プロジェクト詳細・編集
   - プロジェクト削除
   - Slack Webhook URL設定

2. **メンバー管理**
   - プロジェクトメンバー一覧
   - メンバー追加（ディレクター/ユーザーロール指定）
   - メンバー削除
   - 最後のディレクター削除防止

3. **ユーザーロール管理**
   - 全ユーザー一覧表示（オーナーのみ）
   - ユーザーロール変更（owner/director/user）
   - 自分のオーナーロール変更防止

---

## 成果物

### API Routes

| ファイル                                           | メソッド | 説明                                      |
| -------------------------------------------------- | -------- | ----------------------------------------- |
| `/app/api/projects/route.ts`                       | GET      | プロジェクト一覧取得（RLSで自動フィルタ） |
| `/app/api/projects/route.ts`                       | POST     | プロジェクト作成（owner/director のみ）   |
| `/app/api/projects/[id]/route.ts`                  | GET      | プロジェクト詳細取得                      |
| `/app/api/projects/[id]/route.ts`                  | PUT      | プロジェクト更新（director または owner） |
| `/app/api/projects/[id]/route.ts`                  | DELETE   | プロジェクト削除（director または owner） |
| `/app/api/projects/[id]/members/route.ts`          | GET      | メンバー一覧取得                          |
| `/app/api/projects/[id]/members/route.ts`          | POST     | メンバー追加（director または owner）     |
| `/app/api/projects/[id]/members/[userId]/route.ts` | DELETE   | メンバー削除（director または owner）     |
| `/app/api/users/route.ts`                          | GET      | 全ユーザー一覧取得（owner のみ）          |
| `/app/api/users/[id]/route.ts`                     | GET      | ユーザー詳細取得                          |
| `/app/api/users/[id]/route.ts`                     | PUT      | ユーザーロール更新（owner のみ）          |

### UI Pages

| ファイル                                          | 説明                                     |
| ------------------------------------------------- | ---------------------------------------- |
| `/app/(dashboard)/projects/page.tsx`              | プロジェクト一覧ページ                   |
| `/app/(dashboard)/projects/new/page.tsx`          | プロジェクト作成ページ                   |
| `/app/(dashboard)/projects/[id]/page.tsx`         | プロジェクト詳細・編集ページ             |
| `/app/(dashboard)/projects/[id]/members/page.tsx` | メンバー管理ページ                       |
| `/app/(dashboard)/users/page.tsx`                 | ユーザーロール管理ページ（オーナー専用） |

### UI Components (shadcn/ui)

追加インストールしたコンポーネント:

- `alert-dialog` - 削除確認ダイアログ
- `table` - データテーブル表示
- `select` - ドロップダウン選択

---

## 権限設計

### ロール階層

```
Owner (オーナー)
  ├─ システム全体の管理
  ├─ 全プロジェクト・全ユーザー・全通話にアクセス可能
  ├─ ユーザーロール変更可能
  └─ プロジェクト作成可能

Director (ディレクター)
  ├─ プロジェクト作成可能
  ├─ 自分のプロジェクトを管理可能
  ├─ プロジェクトメンバーの追加・削除可能
  └─ 自分のプロジェクトの通話データにアクセス可能

User (ユーザー)
  ├─ 自分の通話記録のみ閲覧可能
  └─ プロジェクト作成不可
```

### アクセス制御ロジック

#### プロジェクト作成

- **許可**: `owner`, `director`
- **拒否**: `user`

#### プロジェクト更新・削除

- **許可**: プロジェクトの `director` メンバー または `owner`
- **拒否**: その他のユーザー

#### メンバー追加・削除

- **許可**: プロジェクトの `director` メンバー または `owner`
- **拒否**: その他のユーザー
- **特殊ルール**: 最後の `director` は削除不可

#### ユーザーロール変更

- **許可**: `owner` のみ
- **拒否**: `director`, `user`
- **特殊ルール**: `owner` は自分の `owner` ロールを変更不可

---

## Row Level Security (RLS) 動作確認

### プロジェクト取得時のRLS

Supabaseの `projects` テーブルには以下のRLSポリシーが適用されています:

```sql
CREATE POLICY "通話アクセス制御" ON projects FOR SELECT
USING (
  -- ユーザーがプロジェクトメンバーである
  EXISTS (
    SELECT 1 FROM project_members
    WHERE project_members.project_id = projects.id
    AND project_members.user_id = auth.uid()
  )
  OR
  -- ユーザーがオーナーである
  EXISTS (
    SELECT 1 FROM users
    WHERE users.id = auth.uid()
    AND users.role = 'owner'
  )
);
```

このRLSポリシーにより、以下が自動的に保証されます:

1. **ユーザーは自分がメンバーのプロジェクトのみ取得可能**
2. **オーナーは全プロジェクトにアクセス可能**
3. **プロジェクトメンバーでないユーザーはプロジェクトを見れない**

### API実装におけるRLS活用

```typescript
// RLSが自動的にフィルタリングするため、追加のフィルタリング不要
const { data: projects } = await supabase
  .from('projects')
  .select('*, project_members!inner(user_id, role, users(name, email))')
  .order('created_at', { ascending: false })
```

- `auth.uid()` が自動的に設定されるため、ユーザーごとに異なる結果が返される
- アプリケーションコードでフィルタリング不要
- セキュリティがデータベースレベルで保証される

---

## バリデーション

### Zod スキーマ

#### プロジェクト作成

```typescript
const CreateProjectSchema = z.object({
  name: z.string().min(1, '名前は必須です').max(255),
  slack_webhook_url: z.string().url('有効なURLを入力してください').optional().nullable(),
})
```

#### プロジェクト更新

```typescript
const UpdateProjectSchema = z.object({
  name: z.string().min(1, '名前は必須です').max(255).optional(),
  slack_webhook_url: z.string().url('有効なURLを入力してください').optional().nullable(),
})
```

#### メンバー追加

```typescript
const AddMemberSchema = z.object({
  user_id: z.string().uuid('有効なユーザーIDを入力してください'),
  role: z.enum(['director', 'user']),
})
```

#### ユーザーロール更新

```typescript
const UpdateUserRoleSchema = z.object({
  role: z.enum(['owner', 'director', 'user']),
})
```

---

## エラーハンドリング

### 標準エラーレスポンス形式

```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "エラーメッセージ（日本語）",
    "details": {
      /* 追加情報 */
    }
  }
}
```

### エラーコード一覧

| コード             | HTTPステータス | 説明                               |
| ------------------ | -------------- | ---------------------------------- |
| `UNAUTHORIZED`     | 401            | 認証が必要です                     |
| `FORBIDDEN`        | 403            | 権限がありません                   |
| `NOT_FOUND`        | 404            | リソースが見つかりません           |
| `VALIDATION_ERROR` | 422            | バリデーションエラー               |
| `ALREADY_MEMBER`   | 409            | 既にメンバーです                   |
| `LAST_DIRECTOR`    | 409            | 最後のディレクターは削除できません |
| `DATABASE_ERROR`   | 500            | データベースエラー                 |
| `INTERNAL_ERROR`   | 500            | サーバーエラー                     |

---

## UI/UX 特徴

### プロジェクト一覧ページ

- **カード形式表示**: プロジェクトごとにカード表示
- **メンバー数表示**: メンバー総数とディレクター数を表示
- **Slack通知ステータス**: Webhook URL設定済みか表示
- **設定ボタン**: 各プロジェクトに設定アイコン
- **新規作成ボタン**: 画面上部に配置

### プロジェクト詳細・編集ページ

- **基本情報編集セクション**: プロジェクト名、Slack Webhook URL
- **メンバー管理セクション**: メンバー管理画面へのリンク
- **危険な操作セクション**: プロジェクト削除（赤色警告）
- **確認ダイアログ**: 削除時に確認ダイアログ表示

### メンバー管理ページ

- **テーブル形式**: メンバー一覧をテーブル表示
- **ロールバッジ**: ディレクター/ユーザーを視覚的に区別
- **メンバー追加ダイアログ**: モーダルダイアログで追加
- **削除確認ダイアログ**: 削除前に確認

### ユーザーロール管理ページ（オーナー専用）

- **全ユーザー一覧**: システム全体のユーザーをテーブル表示
- **ロールドロップダウン**: 各ユーザーのロールをその場で変更
- **ロール説明セクション**: 各ロールの権限を説明
- **アイコン付きバッジ**: Crown (オーナー), Shield (ディレクター), User (ユーザー)

---

## テスト項目（今後実装）

### 単体テスト

- [ ] プロジェクト作成API - 正常系
- [ ] プロジェクト作成API - バリデーションエラー
- [ ] プロジェクト作成API - 権限エラー（ユーザーロール）
- [ ] プロジェクト更新API - 正常系
- [ ] プロジェクト更新API - 権限エラー（他人のプロジェクト）
- [ ] プロジェクト削除API - 正常系
- [ ] プロジェクト削除API - カスケード削除確認
- [ ] メンバー追加API - 正常系
- [ ] メンバー追加API - 既存メンバーエラー
- [ ] メンバー削除API - 正常系
- [ ] メンバー削除API - 最後のディレクターエラー
- [ ] ユーザーロール更新API - 正常系
- [ ] ユーザーロール更新API - 自分のオーナーロール変更エラー

### 統合テスト

- [ ] プロジェクト作成 → メンバー追加 → メンバー削除フロー
- [ ] プロジェクト作成 → 編集 → 削除フロー
- [ ] ユーザーロール変更 → アクセス権限確認フロー

### E2Eテスト

- [ ] オーナーでログイン → 全プロジェクト表示確認
- [ ] ディレクターでログイン → プロジェクト作成確認
- [ ] ユーザーでログイン → プロジェクト作成不可確認
- [ ] プロジェクトメンバー → プロジェクト表示確認
- [ ] 非メンバー → プロジェクト非表示確認

---

## 技術的ハイライト

### 1. RLSによる自動アクセス制御

Supabaseの Row Level Security を活用することで、アプリケーションコードでのフィルタリングが不要になりました。これにより:

- **セキュリティの向上**: データベースレベルでアクセス制御
- **コードの簡潔性**: 複雑な権限チェックロジック不要
- **保守性の向上**: ポリシーをSQLで一元管理

### 2. Zodバリデーション

全APIエンドポイントでZodを使用したバリデーションを実装:

- **型安全性**: TypeScript型推論でフロントエンドとの整合性保証
- **エラーメッセージ**: わかりやすい日本語エラーメッセージ
- **再利用性**: スキーマの再利用が容易

### 3. Next.js App Router パターン

- **Dynamic Routes**: `[id]`, `[userId]` でRESTful API実装
- **Server Components**: サーバー側でのデータフェッチ
- **Client Components**: インタラクティブなUI実装

### 4. shadcn/ui コンポーネント

- **一貫性**: デザインシステムで統一感のあるUI
- **アクセシビリティ**: ARIA準拠
- **カスタマイズ性**: Tailwind CSSで容易にカスタマイズ

---

## 既知の制限事項

### 1. メンバー追加時のユーザー選択

現状はユーザーIDを直接入力する方式。今後、以下の改善が必要:

- ユーザー検索機能（メールアドレスまたは名前）
- オートコンプリート機能
- 既存メンバーの除外

### 2. プロジェクト削除時のカスケード

プロジェクト削除時、関連する通話データも削除されます。今後、以下の対応が必要:

- 削除前の警告強化（関連データ数表示）
- ソフトデリート（論理削除）オプション
- データエクスポート機能

### 3. ロール変更時の権限反映

ユーザーロール変更後、セッションの再認証が必要な場合があります。今後、以下の対応が必要:

- ロール変更時の自動ログアウト
- リアルタイムでの権限更新（Supabase Realtime）

---

## 次のステップ

### Phase 2: プロンプト管理（M2.1）

次のマイルストーンでは、プロンプト管理機能を実装します:

1. **プロンプト一覧ページ** - プロジェクトごとのプロンプト管理
2. **プロンプト作成・編集フォーム** - マークダウンエディタ統合
3. **プロンプトバージョン管理** - 変更履歴・復元機能
4. **AIアシスタント** - GPT-5によるプロンプト最適化提案

---

## まとめ

M1.6の実装により、Phase 1（基盤構築）が完了しました。これにより:

✅ **マルチテナント対応**: 複数プロジェクトの並行運用が可能
✅ **ロールベースアクセス制御**: owner/director/user の3段階権限管理
✅ **セキュアなアクセス制御**: RLSによるデータベースレベルのセキュリティ
✅ **ユーザーフレンドリーなUI**: shadcn/uiによる洗練されたインターフェース

Phase 1の全マイルストーン（M1.1〜M1.6）が完了し、システムの基盤が確立されました。次のPhase 2では、AIフィードバック生成の核となるプロンプト管理機能を実装していきます。
