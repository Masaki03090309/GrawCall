# M2.1 完了レポート: プロンプト管理UI

**完了日**: 2025-11-04
**マイルストーン**: M2.1 - プロンプト管理UI
**ステータス**: ✅ 完了

---

## 実装概要

M2.1では、AIフィードバック生成に使用するプロンプトの管理機能を実装しました。マークダウンエディタ、バージョン管理、履歴追跡機能を備えた完全なプロンプト管理システムが完成しました。

### 実装した機能

1. **プロンプト一覧ページ**
   - タブ切り替え（つながった通話用 / 受付に当たった通話用）
   - アクティブバージョン表示
   - バージョン履歴表示
   - プロンプト編集・削除機能

2. **プロンプト作成フォーム**
   - マークダウンエディタ統合（@uiw/react-md-editor）
   - リアルタイム文字数カウンター
   - プロンプトタイプ選択（connected/reception）
   - 変更コメント記録
   - アクティブフラグ設定

3. **プロンプト編集フォーム**
   - 既存プロンプトの編集
   - マークダウンプレビュー
   - バージョン情報表示

4. **変更履歴表示**
   - 過去10件のバージョン履歴表示
   - 各バージョンの内容確認
   - 変更コメント表示
   - アクティブバージョンハイライト

---

## 成果物

### API Routes

| ファイル                                 | メソッド | 説明                                                    |
| ---------------------------------------- | -------- | ------------------------------------------------------- |
| `/app/api/prompts/route.ts`              | GET      | プロンプト一覧取得（project_id、prompt_typeでフィルタ） |
| `/app/api/prompts/route.ts`              | POST     | プロンプト作成（自動バージョン番号付与）                |
| `/app/api/prompts/[id]/route.ts`         | GET      | 個別プロンプト取得                                      |
| `/app/api/prompts/[id]/route.ts`         | PUT      | プロンプト更新（content、is_activeのみ）                |
| `/app/api/prompts/[id]/route.ts`         | DELETE   | プロンプト削除                                          |
| `/app/api/prompts/[id]/history/route.ts` | GET      | プロンプト履歴取得（過去10件）                          |

### UI Pages

| ファイル                                                             | 説明                             |
| -------------------------------------------------------------------- | -------------------------------- |
| `/app/(dashboard)/projects/[id]/prompts/page.tsx`                    | プロンプト一覧ページ（タブ表示） |
| `/app/(dashboard)/projects/[id]/prompts/new/page.tsx`                | プロンプト作成ページ             |
| `/app/(dashboard)/projects/[id]/prompts/[promptId]/edit/page.tsx`    | プロンプト編集ページ             |
| `/app/(dashboard)/projects/[id]/prompts/[promptId]/history/page.tsx` | プロンプト履歴ページ             |

### Dependencies

追加インストールしたパッケージ:

- `@uiw/react-md-editor` - マークダウンエディタ
- `react-markdown` - マークダウンレンダリング
- `remark-gfm` - GitHub Flavored Markdown対応

---

## データベース設計

### promptsテーブル構造

```sql
CREATE TABLE prompts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  prompt_type VARCHAR(50) NOT NULL CHECK (prompt_type IN ('connected', 'reception')),
  content TEXT NOT NULL,
  version INT NOT NULL DEFAULT 1,
  created_by UUID REFERENCES users(id),
  change_comment TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(project_id, prompt_type, version)
);
```

### バージョン管理ロジック

1. **自動バージョン番号付与**
   - 新規作成時、同じproject_id・prompt_typeの最新バージョン番号 + 1を自動付与
   - 初回作成時はversion 1

2. **アクティブフラグ管理**
   - `is_active=true`のプロンプトが実際のAIフィードバック生成に使用される
   - 同じprompt_typeで複数のアクティブプロンプトは存在できない
   - 新規プロンプトをアクティブにすると、既存のアクティブプロンプトは自動的に非アクティブになる

3. **変更コメント**
   - 各バージョンに変更理由を記録可能（任意）
   - 履歴追跡とレビューに活用

---

## API仕様

### GET /api/prompts

**クエリパラメータ**:

- `project_id` (必須): プロジェクトID
- `prompt_type` (任意): プロンプトタイプ（connected / reception）

**レスポンス**:

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "project_id": "uuid",
        "prompt_type": "connected",
        "content": "プロンプト内容...",
        "version": 2,
        "created_by": "uuid",
        "change_comment": "変更コメント",
        "is_active": true,
        "created_at": "2025-11-04T10:00:00Z",
        "created_by_user": {
          "id": "uuid",
          "name": "山田太郎",
          "email": "yamada@example.com"
        }
      }
    ],
    "total": 5
  }
}
```

### POST /api/prompts

**リクエスト**:

```json
{
  "project_id": "uuid",
  "prompt_type": "connected",
  "content": "プロンプト内容...",
  "change_comment": "初回作成",
  "is_active": true
}
```

**レスポンス**:

```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "project_id": "uuid",
    "prompt_type": "connected",
    "content": "プロンプト内容...",
    "version": 1,
    "change_comment": "初回作成",
    "is_active": true,
    "created_at": "2025-11-04T10:00:00Z"
  }
}
```

### PUT /api/prompts/:id

**リクエスト**:

```json
{
  "content": "更新されたプロンプト内容...",
  "is_active": true
}
```

### GET /api/prompts/:id/history

**レスポンス**:

```json
{
  "success": true,
  "data": {
    "history": [
      {
        "id": "uuid",
        "version": 3,
        "content": "最新プロンプト...",
        "change_comment": "フィードバック改善",
        "is_active": true,
        "created_at": "2025-11-04T12:00:00Z",
        "created_by_user": { "name": "山田太郎" }
      },
      {
        "id": "uuid",
        "version": 2,
        "content": "前バージョン...",
        "is_active": false,
        "created_at": "2025-11-03T10:00:00Z"
      }
    ],
    "total": 2
  }
}
```

---

## UI/UX 特徴

### プロンプト一覧ページ

- **タブ切り替え**: つながった通話用 / 受付に当たった通話用を切り替え
- **アクティブバージョン表示**: タブにアクティブバージョン番号をバッジ表示
- **カード表示**: 各バージョンをカード形式で表示
- **空状態**: プロンプトがない場合は作成を促すメッセージ表示

### プロンプト作成/編集フォーム

- **マークダウンエディタ**:
  - リアルタイムプレビュー（`preview="edit"`）
  - シンタックスハイライト
  - GitHub Flavored Markdown対応
  - 高さ400pxで固定

- **文字数カウンター**:
  - エディタ上部にリアルタイム表示
  - カンマ区切りで見やすく表示

- **プロンプトタイプ選択**:
  - ドロップダウンで選択
  - URLパラメータでデフォルト値設定可能

- **変更コメント**:
  - テキストエリアで自由入力
  - 任意項目

- **アクティブフラグ**:
  - チェックボックスで設定
  - デフォルトON

### 履歴表示ページ

- **時系列表示**: 最新バージョンから過去10件を表示
- **アクティブハイライト**: アクティブバージョンを青色で強調
- **変更コメント表示**: 各バージョンの変更理由を表示
- **作成者情報**: 作成日時と作成者名を表示

---

## 権限設計

### プロンプト作成

- **許可**: `owner`, `director` (プロジェクトメンバーのdirector)
- **拒否**: `user`

### プロンプト更新・削除

- **許可**: プロジェクトの `director` メンバー または `owner`
- **拒否**: その他のユーザー

### プロンプト閲覧

- **許可**: プロジェクトメンバー全員（RLSで自動制御）
- **拒否**: プロジェクトに所属していないユーザー

---

## バリデーション

### プロンプト作成時

```typescript
const CreatePromptSchema = z.object({
  project_id: z.string().uuid('有効なプロジェクトIDを入力してください'),
  prompt_type: z.enum(['connected', 'reception'], {
    errorMap: () => ({
      message: 'プロンプトタイプは connected または reception である必要があります',
    }),
  }),
  content: z.string().min(1, 'プロンプト内容は必須です'),
  change_comment: z.string().optional(),
  is_active: z.boolean().optional().default(true),
})
```

### プロンプト更新時

```typescript
const UpdatePromptSchema = z.object({
  content: z.string().min(1, 'プロンプト内容は必須です').optional(),
  is_active: z.boolean().optional(),
})
```

---

## エラーハンドリング

### エラーコード一覧

| コード             | HTTPステータス | 説明                                      |
| ------------------ | -------------- | ----------------------------------------- |
| `UNAUTHORIZED`     | 401            | 認証が必要です                            |
| `FORBIDDEN`        | 403            | プロンプトを作成/更新する権限がありません |
| `NOT_FOUND`        | 404            | プロンプトが見つかりません                |
| `VALIDATION_ERROR` | 422            | バリデーションエラー                      |
| `DATABASE_ERROR`   | 500            | データベースエラー                        |
| `INTERNAL_ERROR`   | 500            | サーバーエラー                            |

---

## 技術的ハイライト

### 1. マークダウンエディタの動的インポート

```typescript
const MDEditor = dynamic(() => import('@uiw/react-md-editor'), { ssr: false })
```

- SSR無効化でハイドレーションエラーを回避
- クライアントサイドでのみレンダリング

### 2. 自動バージョン番号付与

```typescript
const { data: latestPrompt } = await supabase
  .from('prompts')
  .select('version')
  .eq('project_id', project_id)
  .eq('prompt_type', prompt_type)
  .order('version', { ascending: false })
  .limit(1)
  .maybeSingle()

const newVersion = latestPrompt ? latestPrompt.version + 1 : 1
```

### 3. アクティブフラグの排他制御

```typescript
if (is_active) {
  await supabase
    .from('prompts')
    .update({ is_active: false })
    .eq('project_id', project_id)
    .eq('prompt_type', prompt_type)
}
```

- 同じprompt_typeの既存アクティブプロンプトを自動的に非アクティブ化

### 4. created_by_userの結合クエリ

```typescript
const { data: prompts } = await supabase
  .from('prompts')
  .select('*, created_by_user:users!created_by(id, name, email)')
  .eq('project_id', projectId)
```

- Supabaseの外部キー結合機能を活用
- 作成者情報を一度のクエリで取得

---

## テスト項目（今後実装）

### 単体テスト

- [ ] プロンプト作成API - 正常系
- [ ] プロンプト作成API - バージョン番号自動付与
- [ ] プロンプト作成API - アクティブフラグ排他制御
- [ ] プロンプト作成API - 権限エラー（userロール）
- [ ] プロンプト更新API - 正常系
- [ ] プロンプト更新API - 権限エラー（他人のプロジェクト）
- [ ] プロンプト削除API - 正常系
- [ ] プロンプト履歴API - 過去10件取得

### 統合テスト

- [ ] プロンプト作成 → アクティブ化 → 既存プロンプト非アクティブ化フロー
- [ ] プロンプト作成 → 編集 → 履歴確認フロー
- [ ] 複数バージョン作成 → 履歴取得フロー

### E2Eテスト

- [ ] ディレクターでログイン → プロンプト作成確認
- [ ] ユーザーでログイン → プロンプト作成不可確認
- [ ] マークダウンエディタ動作確認
- [ ] 文字数カウンター更新確認
- [ ] タブ切り替え動作確認

---

## 既知の制限事項

### 1. バージョン復元機能

現状は履歴の閲覧のみ可能。今後、以下の機能が必要:

- ワンクリックでの過去バージョン復元
- 復元時の確認ダイアログ
- 復元後の新バージョン作成

### 2. プロンプト比較機能

複数バージョン間の差分表示機能はまだ実装されていません。今後、以下の対応が必要:

- 2つのバージョン選択
- Diff表示（追加/削除行のハイライト）
- サイドバイサイド比較

### 3. プロンプトテスト機能

プロンプトの動作確認機能がありません。今後、以下の対応が必要:

- サンプル通話データでのテスト実行
- 生成されたフィードバックのプレビュー
- A/Bテスト機能

---

## 次のステップ

### M2.2: プロンプトバージョン管理（1週間）

次のマイルストーンでは、以下の機能を実装します:

1. **バージョン復元機能** - 過去バージョンから復元
2. **バージョン比較機能** - 2つのバージョンのDiff表示
3. **トリガーによる自動バージョン管理** - 更新時の自動バージョニング
4. **バージョンコメント編集** - 既存バージョンのコメント編集

---

## まとめ

M2.1の実装により、プロンプト管理システムの基盤が完成しました。これにより:

✅ **完全なCRUD操作**: 作成・読取・更新・削除がすべて実装
✅ **マークダウン対応**: 見やすいプロンプト編集が可能
✅ **バージョン管理**: 変更履歴の追跡と確認が可能
✅ **権限制御**: director/owner のみが編集可能
✅ **アクティブフラグ管理**: 実際に使用するプロンプトを明確に管理

Phase 2の最初のマイルストーンが完了し、AIフィードバック生成のための基盤が整いました。次のM2.2では、より高度なバージョン管理機能を実装していきます。
