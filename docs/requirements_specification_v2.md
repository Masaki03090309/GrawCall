# Zoom Phone フィードバックシステム 拡張版 詳細要件定義書

**バージョン**: 2.2.0
**作成日**: 2025-01-15
**最終更新**: 2025-01-15
**ステータス**: 要件定義完了（トークスクリプト機能追加版）

---

## 目次

1. [システム概要](#1-システム概要)
2. [アーキテクチャ設計](#2-アーキテクチャ設計)
3. [技術スタック](#3-技術スタック)
4. [機能要件](#4-機能要件)
5. [ロール・権限管理](#5-ロール権限管理)
6. [データモデル](#6-データモデル)
7. [コスト試算](#7-コスト試算)
8. [開発フェーズ](#8-開発フェーズ)
9. [非機能要件](#9-非機能要件)
10. [制約事項](#10-制約事項)

---

## 1. システム概要

### 1.1 目的

Zoom Phone通話録音を自動処理し、営業フィードバック生成、感情分析、KPI管理を統合したWebアプリケーションを構築する。

### 1.2 主要な変更点（現行システムからの拡張）

| 項目                 | 現行システム         | 拡張版                                                   |
| -------------------- | -------------------- | -------------------------------------------------------- |
| **アーキテクチャ**   | GAS + Google Drive   | 完全新規（Cloud Run + Supabase + Next.js）               |
| **ストレージ**       | Google Drive         | Google Cloud Storage (GCS)                               |
| **プロンプト管理**   | スプレッドシート     | Webアプリ + プロジェクト別設定                           |
| **学習資料参照**     | なし                 | PDF/CSV からRAG検索                                      |
| **トークスクリプト** | なし                 | プロジェクト別設定 + 一致率分析 + 因果関係フィードバック |
| **ユーザー管理**     | スプレッドシート     | ロールベース権限管理（オーナー/ディレクター/ユーザー）   |
| **感情分析**         | なし                 | 音声周波数解析 + グラフ表示                              |
| **KPI管理**          | なし                 | リアルタイムダッシュボード                               |
| **NG理由分析**       | なし                 | AI自動判定 + 集計グラフ + フィードバック品質向上への活用 |
| **通知**             | Slack（Driveリンク） | Slack（Webアプリリンク）                                 |

---

## 2. アーキテクチャ設計

### 2.1 システム構成図

```
┌─────────────┐
│ Zoom Phone  │
└──────┬──────┘
       │ Webhook
       ↓
┌─────────────────────────────────────────┐
│        Cloud Run (zoom-proxy)           │
│  - Webhook受信・検証                     │
│  - イベント振り分け                       │
└──────┬──────────────────────────────────┘
       │
       ↓
┌─────────────────────────────────────────┐
│      Cloud Run (backend-processor)      │
│  - 音声ダウンロード                       │
│  - 文字起こし（Whisper API）              │
│  - 通話状態判定（GPT-5-mini）             │
│  - トークスクリプト一致率分析（GPT-5）     │
│  - フィードバック生成（GPT-5-mini + RAG）  │
│  - RAG検索結果の活用（GPT-5）             │
│  - 感情分析（音声周波数解析）              │
│  - アポイント/有効リード判定（GPT-5-mini） │
│  - NG理由判定（GPT-5-mini）               │
└──────┬──────────────────────────────────┘
       │
       ├─────→ GCS（音声・文字起こしファイル）
       │
       ↓
┌─────────────────────────────────────────┐
│          Supabase (PostgreSQL)          │
│  - 通話メタデータ                         │
│  - ユーザー・ロール管理                    │
│  - プロジェクト管理                        │
│  - プロンプト管理（履歴含む）              │
│  - トークスクリプト管理（履歴含む）         │
│  - 学習資料メタデータ                      │
│  - KPIデータ                             │
│  - NG理由データ                           │
│  - pgvector（RAG用ベクトル検索）          │
└──────┬──────────────────────────────────┘
       │
       ↓
┌─────────────────────────────────────────┐
│        Next.js (App Router)             │
│  - ダッシュボード                         │
│  - プロンプト管理UI                       │
│  - トークスクリプト管理UI                  │
│  - 学習資料管理                           │
│  - ユーザー・プロジェクト管理              │
│  - 通話詳細・感情分析グラフ                │
│  - トークスクリプト一致率表示              │
│  - KPI可視化                             │
│  - NG理由分析                            │
└─────────────────────────────────────────┘
       │
       ├─────→ Slack（通知）
       └─────→ OpenAI API（Whisper, GPT-5, GPT-5-mini）
```

### 2.2 データフロー

#### 通話処理フロー

```
1. Zoom Webhook → Cloud Run Proxy
   ↓
2. イベント検証・振り分け
   ↓
3. Backend Processor起動
   ↓
4. 音声ダウンロード → GCS保存
   ↓
5. 文字起こし（Whisper API） → GCS保存
   ↓
6. 並列処理:
   a. 通話状態判定（GPT-5-mini: connected/reception/no_conversation）
   b. 感情分析（音声周波数解析）
   c. プロジェクト別学習資料をRAG検索
   d. **過去1ヶ月のNG理由トレンド集計**
   e. **トークスクリプト一致率分析**（GPT-5: フェーズ別セマンティック一致率）
   ↓
7. フィードバック生成判定:
   【条件分岐】
   - connected かつ 通話時間 ≧ 1分 → フィードバック生成
     - 学習資料あり: GPT-5（RAG活用 + NG理由トレンド + **トークスクリプト一致率** + **因果関係分析**）
     - 学習資料なし: GPT-5-mini（NG理由トレンド + **トークスクリプト一致率** + **因果関係分析**）
   - connected かつ 通話時間 < 1分 → フィードバック生成せず（Slack: "つながっただけ"）
   - reception → フィードバック生成せず（Slack: "受付に当たっただけ"）
   - no_conversation → フィードバック生成せず
   ↓
8. AI判定（GPT-5-mini）※フィードバック生成時のみ:
   a. アポイント獲得判定（仮）
   b. 有効リード判定（仮）
   c. NG理由判定（既存分類に自動分類）
   ↓
9. Supabaseにメタデータ保存
   ↓
10. Slack通知（Webアプリリンク + ステータスメッセージ）
```

---

## 3. 技術スタック

### 3.1 採用技術

| レイヤー           | 技術                                                   | 理由                                           |
| ------------------ | ------------------------------------------------------ | ---------------------------------------------- |
| **フロントエンド** | Next.js 14 (App Router)                                | サーバーコンポーネント、API Routes、認証統合   |
| **UI ライブラリ**  | shadcn/ui + Tailwind CSS                               | モダンなUI、カスタマイズ性                     |
| **データベース**   | Supabase (PostgreSQL)                                  | 認証、リアルタイムDB、ベクトル検索（pgvector） |
| **ストレージ**     | Google Cloud Storage                                   | 音声ファイル、低コスト                         |
| **バックエンド**   | Cloud Run (Node.js/TypeScript)                         | サーバーレス、スケーラブル、GCP統合            |
| **認証**           | Supabase Auth                                          | Google OAuth、メール+パスワード対応            |
| **AI/ML**          | OpenAI API (Whisper, GPT-5-mini, GPT-5)                | 文字起こし、判定、フィードバック生成           |
| **ベクトル検索**   | Supabase pgvector + OpenAI Embedding API               | RAG実装                                        |
| **音声分析**       | librosa (Python) / Web Audio API                       | 周波数解析                                     |
| **グラフ描画**     | Recharts / Chart.js                                    | KPI、感情分析グラフ                            |
| **通知**           | Slack Webhook API                                      | 既存Slack連携継続                              |
| **デプロイ**       | Vercel (フロントエンド) + GCP Cloud Run (バックエンド) | 自動デプロイ、スケーリング                     |

### 3.2 GPT-5 推論モデルの特徴

#### 3.2.1 技術仕様

- **リリース日**: 2025年8月7日
- **モデル**: `gpt-5`, `gpt-5-mini`, `gpt-5-nano`
- **コンテキストウィンドウ**:
  - 入力: 272,000トークン
  - 出力: 128,000トークン（非表示の推論トークンを含む）

#### 3.2.2 Temperature パラメータ不要

**重要**: GPT-5では以下のサンプリングパラメータが**サポートされていません**:

- `temperature`
- `top_p`
- `presence_penalty`
- `frequency_penalty`
- `logprobs`
- `top_logprobs`
- `logit_bias`

**理由**: 推論モデルは内部で複数ラウンドの推論・検証・選択を実行するため、サンプリングパラメータを外部から制御すると高品質な出力が阻害される

**実装時の注意**: これらのパラメータを指定すると `400 Bad Request` エラーが発生するため、API呼び出し時は**パラメータを完全に省略**する

#### 3.2.3 新しいパラメータ

- **`verbosity`**: 応答の詳細度を制御（`low`, `medium`, `high`）
- **`reasoning_effort`**: 推論の労力レベル（`minimal` 等）

#### 3.2.4 料金（2025年8月時点）

- **gpt-5-mini**:
  - 入力: $0.25/1M トークン
  - 出力: $2.00/1M トークン
- **gpt-5**:
  - 入力: 約$2.50/1M トークン（推定）
  - 出力: 約$10.00/1M トークン（推定）

### 3.3 開発ツール

- **言語**: TypeScript (Next.js, Cloud Run)
- **パッケージ管理**: pnpm
- **リンター**: ESLint + Prettier
- **型安全**: Zod (バリデーション)
- **ORM**: Prisma or Drizzle (Supabase連携)
- **CI/CD**: GitHub Actions
- **監視**: Sentry (エラー追跡)

---

## 4. 機能要件

### 4.1 プロンプト管理機能

#### 4.1.1 プロンプトの種類

- **判定用プロンプト**: デフォルトのみ（プロジェクト固有設定不可）
- **フィードバック生成用プロンプト**: プロジェクトごとに設定可能
  - `connected`用プロンプト（担当者接続時）
  - `reception`用プロンプト（受付止まり時）

#### 4.1.2 プロンプトの優先順位

- プロジェクト固有プロンプトが存在する場合、デフォルトプロンプトは**完全に無視**
- プロジェクト固有プロンプトが未設定の場合、デフォルトプロンプトを使用

#### 4.1.3 AIプロンプトアシスタント

- **機能**: 音声入力からプロンプトを自動生成
- **録音方法**: Web UI上で録音ボタン（最大5分）
- **使用モデル**: **GPT-5**
- **フロー**:
  1. ユーザーが録音ボタンを押す
  2. リアルタイムで音声を文字起こし（Whisper API）
  3. 文字起こしテキストをユーザーが確認・編集可能
  4. 「プロンプト生成」ボタンでAIがプロンプト作成
  5. 生成されたプロンプトをユーザーが確認・編集
  6. 保存

#### 4.1.4 プロンプト編集UI

- マークダウン対応テキストエディタ
- 文字数カウンター（トークン数目安表示）
- 変更履歴の閲覧・復元（過去10回分）
- 変更者、変更日時、変更コメント記録

#### 4.1.5 プロンプトテスト機能

- 過去の通話データを手動選択してテスト実行
- 新旧プロンプトの比較表示
- テスト結果のCSVエクスポート

#### 4.1.6 プロンプトバージョン管理

- 各通話データに使用したプロンプトバージョンを記録
- プロンプト本文のスナップショット保存
- プロンプト変更時、既存の通話データは再評価しない

---

### 4.2 学習資料管理機能（RAG）

#### 4.2.1 学習資料の種類

1. **詳細資料（PDF）**
   - 内容: プロジェクトの商品・サービスの詳細説明
   - 上限: プロジェクトあたり2ファイルまで
   - 用途: フィードバック時に「詳細を正しく説明できているか」を評価

2. **事例集（PDF or CSV）**
   - **内容**: 商材の導入事例
     - 導入企業名
     - 企業の業種
     - もともと抱えていた課題
     - 導入後の解決内容・効果
   - **上限**: プロジェクトあたり5ファイルまで
   - **用途**:
     - 通話相手の企業と同業種の事例を参照
     - フィードバック時に「○○業界の△△社様では、同様の課題を□□で解決しました」のような具体的な提案を生成
     - 第三者事例を活用した説得力のある営業トークの評価

#### 4.2.2 ファイル上限

- 1ファイルあたりの最大サイズ: 10MB
- プロジェクトあたりの合計: 詳細資料2個 + 事例集5個 = 最大7ファイル

#### 4.2.3 RAG実装方式

- **ベクトルDB**: Supabase pgvector
- **Embedding**: OpenAI Embedding API (`text-embedding-3-small`)
- **検索方式**: 通話内容に関連する上位5件を検索
- **プロンプト埋め込み**: 検索結果をフィードバック生成プロンプトに動的に追加
- **RAG活用モデル**: **GPT-5**（学習資料を参照した高品質なフィードバック生成）
- **基本フィードバック生成**: **GPT-5-mini**（学習資料なしの標準フィードバック）

**事例集の検索ロジック（例）:**

```
【通話内容から抽出】
- 顧客企業: 「△△運送株式会社」
- 業種: 「物流・運送業」
- 課題: 「配送ドライバーの人手不足」

【事例集から検索（ベクトル検索）】
→ 関連事例: 「××運輸株式会社（物流業）の導入事例」
   - 課題: ドライバー不足による配送遅延
   - 解決: 配車システム導入で効率化、必要人員20%削減
   - 効果: 配送時間30%短縮、顧客満足度向上

【フィードバック生成（GPT-5）】
「物流業界で同様の課題を抱えている××運輸様の事例を引き合いに出せば、
より説得力のある提案になります。『ドライバー不足の課題に対して、
当社のシステムを導入した××運輸様では、必要人員を20%削減しながら
配送時間を30%短縮されました』というトークを追加しましょう。」
```

#### 4.2.4 学習資料のアップロード

- Webアプリの管理画面からアップロード
- アップロード時に自動でベクトル化（Embedding API）
- 更新時は即座に反映（次の通話から有効）

#### 4.2.5 学習資料のプレビュー

- WebアプリでPDF/CSVを閲覧可能
- PDF: iframe埋め込み表示
- CSV: テーブル形式で表示

---

### 4.3 ユーザー・ロール管理機能

#### 4.3.1 認証方式

- **Supabase Auth** 使用
- 対応認証方法:
  - **Google OAuth**（推奨）
  - **メール+パスワード**（認証メール送信）

#### 4.3.2 ロール定義

| ロール           | 人数制限 | 権限                                                                                                 |
| ---------------- | -------- | ---------------------------------------------------------------------------------------------------- |
| **オーナー**     | 2人まで  | システム全体の管理、全プロジェクト閲覧・編集、ユーザー管理、プロジェクト作成・削除、NG理由分類の作成 |
| **ディレクター** | 無制限   | 担当プロジェクトの管理、プロンプト編集、学習資料アップロード、メンバーの通話ログ閲覧                 |
| **ユーザー**     | 無制限   | 自分の通話ログ・フィードバック閲覧、自分のKPI閲覧のみ                                                |

#### 4.3.3 権限詳細

**オーナー:**

- プロジェクトの作成・削除
- 全ユーザーのロール変更
- 全プロジェクトへのメンバーアサイン・削除
- 全プロジェクトのデータ閲覧
- デフォルトプロンプトの編集
- NG理由分類の作成・編集
- システム設定の変更

**ディレクター:**

- 担当プロジェクトのプロンプト編集（connected/reception別）
- 担当プロジェクトの学習資料アップロード・削除
- 担当プロジェクトのメンバー管理（ユーザーロールの追加・削除）
- 担当プロジェクトの全メンバーの通話ログ閲覧
- 担当プロジェクトのKPI閲覧
- 担当プロジェクトのNG理由閲覧・分析

**ユーザー:**

- 自分の通話ログ閲覧
- 自分のフィードバック閲覧
- 自分のKPI閲覧
- アポイント/有効リード判定の確認・修正（自分の通話のみ）

#### 4.3.4 プロジェクト構造

```
オーナー（最大2人）
 ├── プロジェクトA
 │    ├── ディレクター: 田中
 │    └── ユーザー: 佐藤、鈴木、高橋
 ├── プロジェクトB
 │    ├── ディレクター: 伊藤
 │    └── ユーザー: 渡辺、山本
 └── プロジェクトC
      ├── ディレクター: 田中（複数プロジェクト担当可能）
      └── ユーザー: 中村、小林
```

---

### 4.4 音声感情分析機能

#### 4.4.1 分析対象

- **営業担当者**: グラフ上半分（正の値）
- **顧客**: グラフ下半分（負の値）

#### 4.4.2 分析項目

1. **周波数解析**: 声のトーン（高音=興奮/不快、低音=落胆/安心）
2. **音量解析**: 声の大きさ（威圧的、弱気、自信）
3. **話速解析**: 話すスピード（焦り、落ち着き）
4. **沈黙解析**: 沈黙の長さ・頻度（迷い、不快感）
5. **フィラーワード**: 「えー」「あー」等の頻度（緊張度）

#### 4.4.3 グラフ表示形式

```
周波数 (Hz)
  ↑
  |  ～～～～～～～営業担当の波形（正の領域）～～～～
  |  ------------------------------------------------
  0 |================================================→ 時間（秒）
  |  ------------------------------------------------
  |  ～～～～～～～顧客の波形（負の領域）～～～～～～
  ↓
```

- **横軸**: 時間（通話開始〜終了）
- **縦軸**: 周波数（Hz）
- **カラーマップ**: 感情スコアに応じた色分け
  - 緑: ポジティブ（関心、興味）
  - 黄: ニュートラル
  - 赤: ネガティブ（不快、拒絶）

#### 4.4.4 実装方式

- **優先**: 既存API調査（Google Cloud Speech-to-Text 感情分析、Azure Emotion API等）
- **代替**: 独自実装（librosa + Python）

#### 4.4.5 表示位置

- 通話詳細ページ内にグラフ表示
- グラフ上の任意の時点をクリック → 該当箇所の文字起こし・音声再生

---

### 4.5 KPI管理・ダッシュボード機能

#### 4.5.1 KPI項目

| KPI              | 説明                     | 計算方法                |
| ---------------- | ------------------------ | ----------------------- |
| **架電数**       | 総通話件数               | 全通話をカウント        |
| **接続数**       | 担当者接続成功件数       | `connected` 件数        |
| **受付止まり数** | 受付で止まった件数       | `reception` 件数        |
| **会話なし数**   | 会話が成立しなかった件数 | `no_conversation` 件数  |
| **接続率**       | 接続成功率               | (接続数 / 架電数) × 100 |
| **アポイント数** | アポイント獲得件数       | AI判定 + ユーザー確認   |
| **有効リード数** | 有効リード件数           | AI判定 + ユーザー確認   |

#### 4.5.2 集計単位

- **日次**: 当日のKPI
- **週次**: 直近7日間
- **月次**: 当月のKPI
- **カスタム期間**: 任意の日付範囲

#### 4.5.3 表示単位

- **全体**: システム全体のKPI
- **プロジェクト別**: プロジェクトごとのKPI
- **ユーザー別**: 営業担当者ごとのKPI
- **時間帯別**: 午前/午後/夕方等の接続率分析

#### 4.5.4 グラフ形式

- 折れ線グラフ: KPIの推移（日次・週次）
- 棒グラフ: ユーザー別の架電数・接続数比較
- 円グラフ: connected/reception/no_conversation の比率
- ランキング表: 接続率トップ5、アポイント数トップ5

#### 4.5.5 更新頻度

- **リアルタイム更新**: 通話処理完了後、即座にダッシュボードに反映
- 実装方式: Supabase Realtime Subscription

---

### 4.6 NG理由分析機能

#### 4.6.1 NG理由の判定フロー

- **使用モデル**: **GPT-5-mini**

```
1. 通話が `reception` または `connected` で終了
   ↓
2. GPT-5-miniが文字起こしからNG理由を判定
   ↓
3. 既存のNG理由分類に自動分類
   ├→ マッチした場合: その分類に記録
   └→ マッチしない場合: 「その他」に記録
   ↓
4. ユーザー/ディレクターが確認
   ↓
5. オーナーが「その他」を確認 → 新しい分類を追加（任意）
```

#### 4.6.2 NG理由の初期分類（例）

オーナーが初期設定可能:

- 価格が理由
- タイミングが悪い
- 競合他社を選定
- ニーズなし
- 担当者不在
- 検討中（追って連絡）
- その他

#### 4.6.3 NG理由の集計・グラフ化

- **円グラフ**: NG理由の比率
- **棒グラフ**: NG理由別の件数
- **時系列グラフ**: NG理由の推移（「最近『価格』理由が増加」等）
- **プロジェクト別**: プロジェクトごとのNG理由分布

#### 4.6.4 NG理由の活用

**基本的な活用:**

- ダッシュボードで可視化
- プロジェクト別・期間別のNG理由分析

**フィードバック品質向上への活用（重要）:**

NG理由データを蓄積・分析することで、フィードバックの質が継続的に向上します。

**実装方式: NG理由トレンドをRAGで参照**

1. **データ蓄積**
   - NG理由は永久保存（通話ログが削除されても残る）
   - プロジェクトごとに集計可能

2. **フィードバック生成時の参照**
   - 過去1ヶ月のNG理由トレンドを自動集計
   - GPT-5に「このプロジェクトで多いNG理由」を追加情報として提供

3. **具体例**

   ```
   【過去1ヶ月のNG理由分析】
   プロジェクトX:
   - 「価格が理由」: 45% ↑（先月比+15%）
   - 「タイミングが悪い」: 30%
   - 「競合他社」: 15%
   - 「ニーズなし」: 10%

   【フィードバック生成（GPT-5）への追加指示】
   「このプロジェクトでは最近『価格が理由』でのNGが45%と急増しています。
   特に以下の観点を重点的に評価してください:
   - 価格に見合う価値を明確に説明できているか
   - 競合との差別化ポイントを伝えられているか
   - ROI（投資対効果）を具体的に示せているか
   - 価格交渉の余地を残しているか」

   【結果】
   → 通話内容に「価格交渉」が含まれる場合、より詳細なフィードバックを生成
   → 営業担当者は価格対応スキルを重点的に改善できる
   ```

4. **継続的な改善サイクル**
   ```
   NG理由蓄積 → トレンド分析 → フィードバック強化 →
   営業スキル向上 → NG理由の変化 → さらなる改善...
   ```

**期待される効果:**

- プロジェクト固有の課題に対応したフィードバック
- NG理由が変化すれば、自動的にフィードバックの重点も変化
- データが蓄積されるほど、フィードバックの精度が向上

---

### 4.7 アポイント・有効リード判定機能

#### 4.7.1 AI仮判定

- **使用モデル**: **GPT-5-mini**
- **入力**: 文字起こしテキスト
- **判定項目**:
  - アポイント獲得: Yes / No / 不明
  - 有効リード: Yes / No / 不明
  - 判定根拠: テキスト抜粋

#### 4.7.2 ユーザー確認・修正

- 通話詳細ページでAI判定結果を表示
- ユーザー（営業担当者）が確認・修正可能
- 修正後、KPIに即座に反映

#### 4.7.3 表示形式

```
【AI判定】
アポイント獲得: Yes（信頼度: 85%）
根拠: 「来週の火曜日、14時にお伺いします」

有効リード: Yes（信頼度: 90%）
根拠: 「予算は3000万円で検討中」

[確認] [修正]
```

---

### 4.8 Slack通知機能

#### 4.8.1 通知内容

以下の情報を通知:

- プロジェクトID
- 通話ステータス（connected/reception/no_conversation）
- お客様電話番号
- **通話時間**（新規追加）
- **Webアプリリンク**（Google Driveリンクから変更）
- フィードバック本文（条件を満たす場合のみ）

**フィードバック通知の条件:**

- ✅ **connected かつ 通話時間 ≧ 1分**: フィードバックあり
- ⚠️ **connected かつ 通話時間 < 1分**: 「つながっただけ」
- 📞 **reception**: 「受付に当たっただけ」
- ❌ **no_conversation**: 「会話なし」

#### 4.8.2 通知例

**パターンA: connected かつ 通話時間 ≧ 1分（フィードバックあり）**

```
【プロジェクトX】 ✅ 担当者接続

通話詳細: https://yourapp.com/calls/abc123
お客様電話番号: 090-1234-5678
通話ステータス: connected
通話時間: 3分45秒

📊 アポイント: 獲得（AI判定）
📝 フィードバック内容:
（フィードバック本文...）
```

**パターンB: connected かつ 通話時間 < 1分（フィードバックなし）**

```
【プロジェクトX】 ⚠️ つながっただけ

通話詳細: https://yourapp.com/calls/abc123
お客様電話番号: 090-1234-5678
通話ステータス: connected
通話時間: 45秒

※ 通話時間が1分未満のため、フィードバックは生成されませんでした。
```

**パターンC: reception（受付止まり）**

```
【プロジェクトX】 📞 受付に当たっただけ

通話詳細: https://yourapp.com/calls/abc123
お客様電話番号: 090-1234-5678
通話ステータス: reception
通話時間: 2分15秒

※ 受付で終了したため、フィードバックは生成されませんでした。
```

**パターンD: no_conversation（会話なし）**

```
【プロジェクトX】 ❌ 会話なし

通話詳細: https://yourapp.com/calls/abc123
お客様電話番号: 090-1234-5678
通話ステータス: no_conversation

※ 留守番電話または応答なし
```

---

### 4.9 通話詳細ページ

#### 4.9.1 表示内容

- 通話基本情報（日時、通話者、電話番号、方向、ステータス）
- 音声ファイル再生プレーヤー
- 文字起こしテキスト（SRT形式、タイムスタンプ付き）
- フィードバック全文
- 感情分析グラフ
- アポイント/有効リード判定（AI仮判定 + ユーザー確認）
- NG理由（該当する場合）
- 使用したプロンプトバージョン

#### 4.9.2 操作

- 音声再生時、文字起こしの該当箇所をハイライト
- 感情分析グラフ上のクリックで、該当時点の音声再生
- アポイント/有効リード判定の修正
- フィードバックの再生成（プロンプト変更後）

---

### 4.10 トークスクリプト管理機能

#### 4.10.1 概要

各プロジェクトに「手本となるトークスクリプト」を設定し、実際の通話内容と比較することで、営業担当者がトークスクリプトをどれだけ実践できているかを定量評価する機能。

**目的:**

- トークスクリプトと実際の通話内容の一致率を測定
- フェーズ別の課題を明確化
- ヒアリング項目の抜け漏れを防止
- 因果関係を考慮した的確なフィードバック生成

#### 4.10.2 トークスクリプトの構造

**4つのフェーズで構成:**

```
【トークスクリプト】（1プロジェクト = 1トークスクリプト）

┌─────────────────────────────────────┐
│ 📝 オープニング                      │
├─────────────────────────────────────┤
│ 自己紹介、アイスブレイク、            │
│ 通話の目的説明などのスクリプト本文    │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 🎤 ヒアリング                        │
├─────────────────────────────────────┤
│ ┌───────────────────────────────┐   │
│ │ 📌 現在の課題（デフォルト・必須）│   │
│ │ スクリプト本文...             │   │
│ └───────────────────────────────┘   │
│ ┌───────────────────────────────┐   │
│ │ 💰 予算感（ディレクターが追加） │   │
│ │ スクリプト本文...             │   │
│ └───────────────────────────────┘   │
│ ┌───────────────────────────────┐   │
│ │ 📅 導入時期（ディレクターが追加）│   │
│ │ スクリプト本文...             │   │
│ └───────────────────────────────┘   │
│ ※ 最大10項目まで追加可能            │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 💡 提案                             │
├─────────────────────────────────────┤
│ 商品説明、価値提案、                 │
│ 事例紹介などのスクリプト本文          │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 🤝 クロージング                      │
├─────────────────────────────────────┤
│ アポイント打診、次回アクション提示    │
│ などのスクリプト本文                 │
└─────────────────────────────────────┘
```

#### 4.10.3 ヒアリング項目の管理

**デフォルト項目:**

- 「現在の課題」は全プロジェクトで**必須項目**として存在（削除不可）

**カスタム項目:**

- ディレクターが自由に追加可能
- 例: 「予算感」「導入時期」「決裁者」「競合検討状況」「稟議プロセス」など
- 上限: **10項目**（現在の課題を含む）
- 各項目には以下を設定:
  - **項目名**: 「予算感」など
  - **スクリプト本文**: 具体的なヒアリング方法・質問例

**UI操作:**

- ヒアリングフェーズ内の [+ ヒアリング項目を追加] ボタンで追加
- カスタム項目には [×] ボタンで削除可能（デフォルト項目は削除不可）

#### 4.10.4 トークスクリプトの入力方法

**方法A: Webエディタで直接入力**

- マークダウン対応のテキストエディタ
- リアルタイムプレビュー
- 文字数カウンター表示
- フェーズごとに入力欄が分かれている

**方法B: PDF取り込み**

1. ディレクターがPDFファイルをアップロード
2. **GPT-5によるテキスト抽出とフェーズ自動判定**
   - まずGPT-5 Vision APIでPDFをテキスト化
   - テキストを「オープニング」「ヒアリング」「提案」「クロージング」に自動分類
   - ヒアリング項目も自動抽出
3. 抽出結果をWebエディタに自動入力
4. ディレクターが確認・編集
5. 保存

**注意:**

- GPT-5で文字認識できない場合は、OCR（Tesseract等）にフォールバック
- PDF取り込み後も必ずWebエディタで確認・編集が必要

#### 4.10.5 バージョン管理

**プロンプトと同様の履歴管理:**

- 過去10バージョンを保存
- 各バージョンには以下を記録:
  - 変更日時
  - 変更者（ディレクター）
  - 変更コメント
  - トークスクリプト本文のスナップショット
- 履歴から過去バージョンの復元が可能
- 通話データには使用したトークスクリプトバージョンIDを記録

#### 4.10.6 権限

| ロール           | 作成                      | 編集                      | 削除                      | 履歴閲覧                  |
| ---------------- | ------------------------- | ------------------------- | ------------------------- | ------------------------- |
| **オーナー**     | ○                         | ○                         | ○                         | ○                         |
| **ディレクター** | ○（担当プロジェクトのみ） | ○（担当プロジェクトのみ） | ○（担当プロジェクトのみ） | ○（担当プロジェクトのみ） |
| **ユーザー**     | ×                         | ×                         | ×                         | ○（閲覧のみ）             |

---

### 4.11 トークスクリプト一致率分析機能

#### 4.11.1 セマンティック（意味的）一致率計算

**使用モデル**: **GPT-5**

**計算方式:**

- 単純なテキスト比較ではなく、**意味的な一致**を評価
- 表現が違っても、意図が同じなら高い一致率

**例:**

```
【トークスクリプト】
「御社の現在の課題をお聞かせいただけますでしょうか？」

【実際の発話】
「今、何か困っていることってありますか？」

→ 表現は異なるが、意味的には同じ
→ セマンティック一致率: 85%
```

**GPT-5への指示例:**

```
以下のトークスクリプトと実際の通話内容を比較し、
各フェーズの意味的な一致率を0〜100%で評価してください。

【評価基準】
- 同じ内容を異なる表現で伝えている場合: 高い一致率
- トークスクリプトの要点を押さえている場合: 中程度の一致率
- 全く触れていない、または意図が異なる場合: 低い一致率

【トークスクリプト】
オープニング: ...
ヒアリング:
  - 現在の課題: ...
  - 予算感: ...
提案: ...
クロージング: ...

【実際の通話（文字起こし）】
...

【出力形式（JSON）】
{
  "overall_match_rate": 76,
  "phase_match_rates": {
    "opening": 85,
    "hearing": 68,
    "proposal": 78,
    "closing": 73
  },
  "hearing_item_coverage": {
    "現在の課題": { "covered": true, "match_rate": 82 },
    "予算感": { "covered": false, "match_rate": 0 },
    "導入時期": { "covered": true, "match_rate": 65 }
  }
}
```

#### 4.11.2 フェーズ別一致率

**4つのフェーズごとに一致率を計算:**

| フェーズ         | 評価内容                                   |
| ---------------- | ------------------------------------------ |
| **オープニング** | 自己紹介、アイスブレイク、目的説明の実施度 |
| **ヒアリング**   | 各ヒアリング項目のカバー状況 + 質問の質    |
| **提案**         | 商品説明の網羅性、価値提案の明確さ         |
| **クロージング** | アポイント打診、次回アクションの提示       |

**総合一致率の計算:**

```
総合一致率 = (オープニング + ヒアリング + 提案 + クロージング) / 4
```

#### 4.11.3 ヒアリング項目カバー率

**ヒアリングフェーズの詳細評価:**

各ヒアリング項目について:

- **カバー済み**: 該当項目について質問・確認できた
- **未カバー**: 該当項目について全く触れていない
- **一致率**: カバー済みの場合、トークスクリプトとの意味的一致率

**カバー率の計算:**

```
ヒアリング項目カバー率 = (カバー済み項目数 / 全ヒアリング項目数) × 100

例: 4項目中3項目カバー → 75%
```

#### 4.11.4 通話詳細ページでの表示

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 トークスクリプト分析
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

総合一致率: 76%

┌──────────────────────────────────┐
│ 📝 オープニング         85% ✅   │
│ 🎤 ヒアリング           68% ⚠️   │
│ 💡 提案                78% ✅   │
│ 🤝 クロージング          73% ✅   │
└──────────────────────────────────┘

【ヒアリング項目カバー状況】
✅ 現在の課題      カバー済み（一致率: 82%）
❌ 予算感         未カバー
✅ 導入時期       カバー済み（一致率: 65%）
✅ 決裁者         カバー済み（一致率: 71%）

ヒアリング項目カバー率: 75% (3/4項目)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**詳細表示（展開可能）:**

```
▼ オープニング（85%）
  【トークスクリプト】
  「お世話になっております。株式会社○○の△△と申します...」

  【実際の発話】
  「お世話になります。○○の△△です...」

  💬 評価: 自己紹介は簡潔だが要点を押さえている

▼ ヒアリング（68%）
  ▼ 現在の課題（82% ✅）
    【トークスクリプト】
    「御社の現在の課題をお聞かせいただけますでしょうか？」

    【実際の発話】
    「今、何か困っていることってありますか？」

    💬 評価: 表現は異なるが、意図は一致

  ▼ 予算感（0% ❌）
    【トークスクリプト】
    「ご予算はどのくらいをお考えでしょうか？」

    【実際の発話】
    （この項目について言及なし）

    💬 評価: 未カバー。次回は必ず確認しましょう。
```

---

### 4.12 因果関係を考慮した統合フィードバック生成

#### 4.12.1 フィードバック生成の4要素統合

**フィードバック生成時に参照する情報:**

1. **トークスクリプト一致率分析**（新規）
   - 総合一致率
   - フェーズ別一致率
   - ヒアリング項目カバー状況

2. **学習資料（RAG検索）**（既存）
   - 詳細資料（PDF）
   - 事例集（PDF/CSV）

3. **過去1ヶ月のNG理由トレンド**（既存）
   - プロジェクト固有のNG理由分布
   - 最近増加しているNG理由

4. **通話の文字起こしテキスト**（既存）
   - 実際の会話内容

#### 4.12.2 営業プロセスの因果関係ロジック

**重要:** 単純に「一致率が低い順」にフィードバックするのではなく、**営業プロセス全体の流れと因果関係**を考慮してフィードバックを生成する。

**因果関係の考え方:**

```
オープニング → ヒアリング → 提案 → クロージング
     ↓            ↓          ↓         ↓
   信頼構築    ニーズ把握  価値提案  次のステップ

※ 前のフェーズが不十分だと、後のフェーズも失敗する
```

#### 4.12.3 因果関係判定ロジック

**パターンA: ヒアリング不足が根本原因**

```
条件:
  ヒアリング < 60%
  AND
  (提案 < 30% OR クロージング < 30%)

診断:
  → ヒアリングが不十分なため、提案・クロージングに進めなかった

フィードバック重点:
  → ヒアリング力の強化
  → 特に未カバーのヒアリング項目を指摘
  → ニーズ・課題の顕在化テクニックを提案
```

**具体例:**

```
【分析結果】
- オープニング: 85%
- ヒアリング: 50%
- 提案: 1%
- クロージング: 5%
- ヒアリング項目「予算感」「導入時期」未カバー

【フィードバック（抜粋）】
今回の通話では、オープニングは良好でしたが、ヒアリングが不十分だったため、
提案・クロージングにほとんど進めませんでした。

特に以下のヒアリング項目が未カバーです:
- 予算感: トークスクリプトでは「ご予算はどのくらいをお考えでしょうか？」
  と確認することになっていますが、今回は全く触れられていません。
- 導入時期: 「いつ頃の導入をお考えですか？」も確認できていません。

これらの情報がないと、適切な提案ができません。
次回は必ずヒアリング項目を網羅しましょう。
```

**パターンB: 提案力不足が根本原因**

```
条件:
  ヒアリング >= 60%
  AND
  提案 < 50%
  AND
  クロージング < 50%

診断:
  → ヒアリングはできているが、提案に活かせていない

フィードバック重点:
  → ヒアリング内容と商品の強みを結びつける
  → 学習資料（事例集）の活用
  → 価値提案の明確化
```

**パターンC: クロージング不足が根本原因**

```
条件:
  ヒアリング >= 60%
  AND
  提案 >= 60%
  AND
  クロージング < 50%

診断:
  → ヒアリング・提案は良好だが、次のステップを提示できていない

フィードバック重点:
  → アポイント打診の具体性
  → 次回訪問の日時提案
  → クロージングトークの実践
```

**パターンD: 全体的に低い場合**

```
条件:
  上記のいずれにも該当しない
  （全フェーズが中程度、または特定パターンに当てはまらない）

診断:
  → 営業プロセス全体の流れに沿って改善提案

フィードバック重点:
  → 最も低いフェーズから順に指摘
  → ただし、因果関係は常に考慮
```

#### 4.12.4 GPT-5へのシステムプロンプト（例）

```
あなたは営業フィードバック生成AIです。
以下の情報をもとに、営業担当者への具体的なフィードバックを生成してください。

【入力情報】
1. トークスクリプト分析結果:
   - 総合一致率: 76%
   - オープニング: 85%
   - ヒアリング: 50%
   - 提案: 1%
   - クロージング: 5%
   - ヒアリング項目カバー状況:
     ✅ 現在の課題: カバー済み (82%)
     ❌ 予算感: 未カバー
     ❌ 導入時期: 未カバー
     ✅ 決裁者: カバー済み (65%)

2. 学習資料（RAG検索結果）:
   （関連する事例集・詳細資料の抜粋...）

3. 過去1ヶ月のNG理由トレンド:
   - 「価格が理由」: 45% ↑（先月比+15%）
   - 「タイミングが悪い」: 30%
   - 「競合他社」: 15%

4. 通話の文字起こし:
   （実際の会話内容...）

【重要: 因果関係ロジック】
今回のケースでは、ヒアリング < 60% かつ 提案・クロージングが極端に低いため、
「ヒアリング不足が根本原因」と判断してください。

フィードバック生成時は以下を重点的に指摘:
1. ヒアリングが不十分だったこと
2. 特に「予算感」「導入時期」が未カバーであること
3. ヒアリング不足が原因で提案・クロージングに進めなかったこと
4. 次回のヒアリング改善方法

【フィードバック生成】
（上記の情報を統合して、具体的で実践的なフィードバックを生成してください）
```

#### 4.12.5 統合フィードバックの出力例

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 営業フィードバック
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【総合評価】
トークスクリプト総合一致率: 76%

【改善が必要なポイント】

1. ⚠️ ヒアリングの強化が最優先（一致率: 50%）

   今回の通話では、ヒアリングが不十分だったため、
   提案・クロージングにほとんど進めませんでした。

   **未カバーのヒアリング項目:**
   - 予算感: トークスクリプトでは「ご予算はどのくらいを
     お考えでしょうか？」と確認することになっていますが、
     今回は全く触れられていません。
   - 導入時期: 「いつ頃の導入をお考えですか？」も未確認です。

   **改善提案:**
   - ヒアリング項目をリスト化し、通話前に必ず確認
   - 「現在の課題」だけでなく、「予算感」「導入時期」も
     必ず聞くよう習慣化しましょう
   - 顧客の課題を深堀りする質問（「それはなぜですか？」等）
     を追加すると、さらに良いヒアリングになります

2. 💡 提案フェーズについて（一致率: 1%）

   ヒアリング不足のため、今回は提案にほとんど進めませんでした。
   次回はヒアリングを十分に行い、顧客の課題に対して
   以下の事例を活用した提案を行いましょう:

   【関連事例（RAG検索結果）】
   ××運輸株式会社様（物流業）では、ドライバー不足の課題に対して
   当社のシステムを導入し、必要人員を20%削減しながら
   配送時間を30%短縮されました。

3. 🤝 クロージングについて（一致率: 5%）

   提案ができなかったため、クロージングにも進めませんでした。
   次回は、ヒアリング→提案の流れを作り、最後に
   「来週の火曜日14時にお伺いできますか？」のような
   具体的な日時提案を忘れずに行いましょう。

【良かった点】

✅ オープニングは良好（一致率: 85%）
   自己紹介と通話の目的説明はトークスクリプト通りに
   できていました。この調子で、ヒアリング以降も
   スクリプトを実践していきましょう。

【NG理由トレンドからの示唆】

このプロジェクトでは最近「価格が理由」でのNGが45%と
急増しています。次回ヒアリングできた際は、
「価格に見合う価値」を明確に伝え、ROI（投資対効果）を
具体的に示すことを意識してください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### 4.13 その他の機能

#### 4.13.1 フィードバック生成条件

**条件A: connected（担当者接続）の場合**

- **通話時間 ≧ 1分（60秒）**:
  - フィードバック生成あり
  - アポイント/有効リード/NG理由の判定あり
  - Slackに詳細なフィードバックを通知
- **通話時間 < 1分（60秒）**:
  - フィードバック生成なし
  - Slackに「**つながっただけ**」と表示
  - データベースには記録（KPIには「接続数」としてカウント）

**条件B: reception（受付止まり）の場合**

- 通話時間に関わらず:
  - フィードバック生成なし
  - Slackに「**受付に当たっただけ**」と表示
  - データベースには記録（KPIには「受付止まり数」としてカウント）

**条件C: no_conversation（会話なし）の場合**

- フィードバック生成なし
- Slack通知なし（または簡易通知のみ）
- データベースには記録（KPIには「会話なし数」としてカウント）

#### 4.13.2 データ保持ポリシー

**6ヶ月後に削除されるデータ:**

- **音声ファイル（GCS）**: 6ヶ月後に自動削除（GCS Lifecycle設定）
- **文字起こしファイル（GCS）**: 6ヶ月後に自動削除（GCS Lifecycle設定）
- **通話メタデータ（calls テーブル）**: 6ヶ月後に自動削除（Supabase Cron Job）

**永久保存されるデータ:**

- **NG理由ログ（ng_reason_logs テーブル）**: **永久保存**
- **NG理由マスタ（ng_reasons テーブル）**: **永久保存**
- **プロンプト履歴**: 永久保存
- **トークスクリプト履歴**: 永久保存
- **ユーザーデータ**: 永久保存
- **学習資料**: 永久保存（手動削除のみ）

**重要: NG理由データの永久保存設計**

- 通話データ（calls）が6ヶ月後に削除されても、NG理由ログは残り続ける
- NG理由の長期トレンド分析が可能（過去1年以上のデータを参照）
- データベース設計:

  ```sql
  CREATE TABLE ng_reason_logs (
    id UUID PRIMARY KEY,
    call_id UUID REFERENCES calls(id) ON DELETE SET NULL,  -- 通話削除時もログは残す
    ng_reason_id UUID REFERENCES ng_reasons(id),

    -- 通話削除後も参照できるよう、必要な情報を保存
    call_date TIMESTAMP NOT NULL,
    project_id UUID REFERENCES projects(id),
    user_id UUID REFERENCES users(id),
    customer_phone VARCHAR(50),

    ai_confidence DECIMAL(5, 2),
    evidence_text TEXT,
    created_at TIMESTAMP DEFAULT NOW()
  );
  ```

---

## 5. ロール・権限管理

### 5.1 権限マトリクス

| 機能                                       | オーナー | ディレクター              | ユーザー                  |
| ------------------------------------------ | -------- | ------------------------- | ------------------------- |
| **プロジェクト作成・削除**                 | ○        | ×                         | ×                         |
| **ユーザー管理（ロール変更）**             | ○        | ×                         | ×                         |
| **プロジェクトへのメンバーアサイン**       | ○        | ○（担当プロジェクトのみ） | ×                         |
| **デフォルトプロンプト編集**               | ○        | ×                         | ×                         |
| **プロジェクト別プロンプト編集**           | ○        | ○（担当プロジェクトのみ） | ×                         |
| **トークスクリプト作成・編集**             | ○        | ○（担当プロジェクトのみ） | ×                         |
| **トークスクリプト閲覧**                   | ○        | ○（担当プロジェクトのみ） | ○（所属プロジェクトのみ） |
| **学習資料アップロード**                   | ○        | ○（担当プロジェクトのみ） | ×                         |
| **NG理由分類の作成・編集**                 | ○        | ×                         | ×                         |
| **全プロジェクトのKPI閲覧**                | ○        | ×                         | ×                         |
| **担当プロジェクトのKPI閲覧**              | ○        | ○                         | ×                         |
| **自分のKPI閲覧**                          | ○        | ○                         | ○                         |
| **全ユーザーの通話ログ閲覧**               | ○        | ×                         | ×                         |
| **担当プロジェクトメンバーの通話ログ閲覧** | ○        | ○                         | ×                         |
| **自分の通話ログ閲覧**                     | ○        | ○                         | ○                         |
| **アポイント/有効リード判定の修正**        | ○        | ○                         | ○（自分の通話のみ）       |

### 5.2 データアクセス制御

#### 5.2.1 Row Level Security (RLS)

Supabase の RLS を使用してデータアクセスを制御:

```sql
-- 例: 通話データのアクセス制御
CREATE POLICY "ユーザーは自分の通話のみ閲覧可能"
ON calls FOR SELECT
USING (
  auth.uid() = user_id  -- 自分の通話
  OR
  EXISTS (  -- または自分がディレクターのプロジェクトのメンバーの通話
    SELECT 1 FROM project_members
    WHERE project_id = calls.project_id
    AND user_id = auth.uid()
    AND role = 'director'
  )
  OR
  EXISTS (  -- またはオーナー
    SELECT 1 FROM users
    WHERE id = auth.uid()
    AND role = 'owner'
  )
);
```

---

## 6. データモデル

### 6.1 主要テーブル

#### 6.1.1 users（ユーザー）

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255),
  role VARCHAR(50) NOT NULL CHECK (role IN ('owner', 'director', 'user')),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 6.1.2 projects（プロジェクト）

```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL,
  slack_webhook_url TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 6.1.3 project_members（プロジェクトメンバー）

```sql
CREATE TABLE project_members (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role VARCHAR(50) NOT NULL CHECK (role IN ('director', 'user')),
  zoom_user_id VARCHAR(255),
  phone_number VARCHAR(50),
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(project_id, user_id)
);
```

#### 6.1.4 prompts（プロンプト）

```sql
CREATE TABLE prompts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE NULL,  -- NULLの場合はデフォルト
  prompt_type VARCHAR(50) NOT NULL CHECK (prompt_type IN ('connected', 'reception')),
  content TEXT NOT NULL,
  version INT NOT NULL DEFAULT 1,
  created_by UUID REFERENCES users(id),
  change_comment TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 6.1.5 talk_scripts（トークスクリプト）

```sql
CREATE TABLE talk_scripts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  version INT NOT NULL DEFAULT 1,

  -- 各フェーズのスクリプト本文
  opening_script TEXT,
  proposal_script TEXT,
  closing_script TEXT,

  -- バージョン管理
  created_by UUID REFERENCES users(id),
  change_comment TEXT,
  is_active BOOLEAN DEFAULT TRUE,  -- 最新バージョンのみTRUE

  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(project_id, version)
);
```

#### 6.1.6 talk_script_hearing_items（ヒアリング項目）

```sql
CREATE TABLE talk_script_hearing_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  talk_script_id UUID REFERENCES talk_scripts(id) ON DELETE CASCADE,

  item_name VARCHAR(255) NOT NULL,  -- 例: 「現在の課題」「予算感」
  item_script TEXT NOT NULL,  -- ヒアリング方法・質問例
  is_default BOOLEAN DEFAULT FALSE,  -- 「現在の課題」のみTRUE
  display_order INT NOT NULL,  -- 表示順序

  created_at TIMESTAMP DEFAULT NOW()
);

-- デフォルト項目「現在の課題」は削除不可を制約で保証
CREATE INDEX idx_talk_script_hearing_items_script ON talk_script_hearing_items(talk_script_id);
```

#### 6.1.7 learning_materials（学習資料）

```sql
CREATE TABLE learning_materials (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  material_type VARCHAR(50) NOT NULL CHECK (material_type IN ('detail', 'case_study')),
  file_name VARCHAR(255) NOT NULL,
  file_type VARCHAR(50) NOT NULL CHECK (file_type IN ('pdf', 'csv')),
  file_url TEXT NOT NULL,  -- GCS URL
  file_size_mb DECIMAL(10, 2),
  uploaded_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 6.1.8 learning_material_embeddings（学習資料のベクトル）

```sql
CREATE TABLE learning_material_embeddings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  material_id UUID REFERENCES learning_materials(id) ON DELETE CASCADE,
  chunk_text TEXT NOT NULL,
  embedding VECTOR(1536),  -- OpenAI Embedding の次元数
  created_at TIMESTAMP DEFAULT NOW()
);

-- ベクトル検索用インデックス
CREATE INDEX ON learning_material_embeddings USING ivfflat (embedding vector_cosine_ops);
```

#### 6.1.9 calls（通話データ）

```sql
CREATE TABLE calls (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID REFERENCES projects(id),
  user_id UUID REFERENCES users(id),

  -- Zoom情報
  zoom_call_id VARCHAR(255) UNIQUE NOT NULL,
  zoom_recording_id VARCHAR(255) UNIQUE NOT NULL,

  -- 通話情報
  direction VARCHAR(50) CHECK (direction IN ('inbound', 'outbound')),
  caller_number VARCHAR(50),
  callee_number VARCHAR(50),
  duration_seconds INT,
  call_time TIMESTAMP,

  -- ファイルURL
  audio_url TEXT,  -- GCS URL
  transcript_url TEXT,  -- GCS URL

  -- 判定結果
  status VARCHAR(50) CHECK (status IN ('connected', 'reception', 'no_conversation')),
  status_confidence DECIMAL(5, 2),

  -- フィードバック
  feedback_text TEXT,
  prompt_version_id UUID REFERENCES prompts(id),

  -- トークスクリプト分析（新規）
  talk_script_version_id UUID REFERENCES talk_scripts(id),
  overall_match_rate DECIMAL(5, 2),  -- 総合一致率
  phase_match_rates JSONB,  -- フェーズ別一致率 {"opening": 85, "hearing": 68, "proposal": 78, "closing": 73}
  hearing_item_coverage JSONB,  -- ヒアリング項目カバー状況 {"現在の課題": {"covered": true, "match_rate": 82}, ...}

  -- AI判定
  appointment_gained BOOLEAN,
  appointment_confirmed BOOLEAN DEFAULT FALSE,
  valid_lead BOOLEAN,
  valid_lead_confirmed BOOLEAN DEFAULT FALSE,
  ng_reason_id UUID REFERENCES ng_reasons(id),

  -- 感情分析
  emotion_analysis_url TEXT,  -- 感情分析グラフデータ（JSON）

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 6.1.10 ng_reasons（NG理由）

```sql
CREATE TABLE ng_reasons (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID REFERENCES projects(id) NULL,  -- NULLの場合は全プロジェクト共通
  reason_name VARCHAR(255) NOT NULL,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 6.1.11 ng_reason_logs（NG理由ログ）

```sql
CREATE TABLE ng_reason_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  call_id UUID REFERENCES calls(id) ON DELETE CASCADE,
  ng_reason_id UUID REFERENCES ng_reasons(id),
  ai_confidence DECIMAL(5, 2),
  evidence_text TEXT,  -- AI判定の根拠
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 7. コスト試算

### 7.1 月額コスト見積もり（月1,300通話の場合）

| サービス      | 項目                                     | 料金            |
| ------------- | ---------------------------------------- | --------------- |
| **Supabase**  | Pro プラン                               | $25             |
| **GCS**       | ストレージ（6ヶ月累積 7.92GB）           | $0.16           |
| **GCS**       | アップロード・ダウンロード               | $0.01           |
| **Cloud Run** | リクエスト処理（1,300件）                | $5〜10          |
| **OpenAI**    | Whisper API（文字起こし）                | $7.80           |
| **OpenAI**    | Embedding API（RAG）                     | $0.50           |
| **OpenAI**    | GPT-5-mini（判定・フィードバック生成）   | $3.25           |
| **OpenAI**    | GPT-5（RAG検索結果の活用）               | $16.25          |
| **OpenAI**    | GPT-5（トークスクリプト一致率分析）      | $10.00          |
| **OpenAI**    | GPT-5（PDF取り込み時のフェーズ自動判定） | $0.50           |
| **Vercel**    | Hobby（無料） or Pro                     | $0 or $20       |
| **音声分析**  | 既存API利用の場合                        | $5〜15          |
| **合計**      |                                          | **$73〜106/月** |

### 7.2 スケーラビリティ試算

| 通話数/月      | 月額コスト（概算） |
| -------------- | ------------------ |
| 1,300件        | $73〜106           |
| 2,600件（2倍） | $110〜165          |
| 6,500件（5倍） | $240〜360          |

### 7.3 コスト最適化案

- RAG検索結果の活用を選択的に実施（複雑な通話のみGPT-5使用、シンプルな通話はGPT-5-miniのみ）
- トークスクリプト一致率分析の選択的実施（重要な通話のみGPT-5で分析、それ以外はスキップ）
- 学習資料の参照頻度を調整（毎回ではなく必要時のみ）
- 音声分析を独自実装（API費用削減）

### 7.4 GPT-5の利点によるコスト削減

- **Temperature パラメータ不要**: GPT-5は推論モデルのため、`temperature`, `top_p` 等のサンプリングパラメータが不要
- **コード実装がシンプル**: パラメータ調整の試行錯誤が不要になり、開発・保守コストを削減
- **高品質な出力**: 内部で複雑な推論プロセスを実行するため、プロンプトエンジニアリングの負担が軽減

---

## 8. 開発フェーズ

### 8.1 フェーズ1: 基盤構築（1〜2ヶ月）

- [ ] Next.js プロジェクトセットアップ
- [ ] Supabase セットアップ（データベース、認証）
- [ ] Cloud Run セットアップ（Webhook受信）
- [ ] GCS セットアップ（音声ファイル保存）
- [ ] ユーザー認証（Google OAuth + メール+パスワード）
- [ ] ロール・権限管理（RLS設定）
- [ ] プロジェクト管理機能
- [ ] 基本的な通話処理フロー（音声→文字起こし→判定→フィードバック）

### 8.2 フェーズ2: プロンプト管理（1ヶ月）

- [ ] プロンプト管理UI
- [ ] プロンプト変更履歴
- [ ] AIプロンプトアシスタント（音声入力→プロンプト生成）
- [ ] プロンプトテスト機能

### 8.3 フェーズ3: トークスクリプト管理（1ヶ月）

- [ ] トークスクリプト管理UI
- [ ] フェーズ別入力（オープニング/ヒアリング/提案/クロージング）
- [ ] ヒアリング項目管理（追加・削除・編集）
- [ ] PDF取り込み機能（GPT-5によるテキスト抽出・フェーズ自動判定）
- [ ] トークスクリプト変更履歴（過去10バージョン）
- [ ] トークスクリプト一致率分析（GPT-5によるセマンティック評価）
- [ ] フェーズ別一致率表示
- [ ] ヒアリング項目カバー率表示
- [ ] 因果関係を考慮したフィードバック生成ロジック

### 8.4 フェーズ4: 学習資料・RAG（1〜2ヶ月）

- [ ] 学習資料アップロード機能
- [ ] PDF/CSV パース処理
- [ ] Embedding API 連携
- [ ] pgvector セットアップ
- [ ] RAG実装（ベクトル検索→プロンプト埋め込み）
- [ ] 学習資料プレビュー機能

### 8.5 フェーズ5: KPI・ダッシュボード（1ヶ月）

- [ ] KPI集計処理
- [ ] ダッシュボードUI（グラフ描画）
- [ ] リアルタイム更新（Supabase Realtime）
- [ ] アポイント/有効リード判定（AI + ユーザー確認）
- [ ] NG理由判定・集計

### 8.6 フェーズ6: 音声感情分析（1〜2ヶ月）

- [ ] 音声周波数解析（既存API調査 or 独自実装）
- [ ] 感情分析グラフ描画
- [ ] 通話詳細ページ統合

### 8.7 フェーズ7: テスト・改善（1ヶ月）

- [ ] 統合テスト
- [ ] パフォーマンスチューニング
- [ ] UI/UX改善
- [ ] ドキュメント整備

**総開発期間: 7〜10ヶ月**（トークスクリプト機能追加により1ヶ月延長）

---

## 9. 非機能要件

### 9.1 パフォーマンス

- 通話処理時間: 平均3〜5分以内
- ダッシュボード表示: 2秒以内
- 通話詳細ページ表示: 3秒以内
- 音声ファイル再生: 1秒以内に開始

### 9.2 スケーラビリティ

- 同時通話処理: 100件/分
- 想定ユーザー数: 1,000人
- 想定通話データ: 100万件以上

### 9.3 セキュリティ

- 認証: Supabase Auth（OAuth 2.0）
- データアクセス制御: Row Level Security (RLS)
- 音声ファイル: Signed URL（期限付き一時URL）
- 通信: HTTPS/TLS 1.3
- API認証: JWT

### 9.4 可用性

- SLA: 99.9%（Cloud Run, Supabase の SLA に準拠）
- バックアップ: Supabase 自動バックアップ（日次）
- 障害復旧: RPO 24時間、RTO 4時間

### 9.5 保守性

- ログ: Sentry（エラー追跡）、Cloud Logging
- 監視: Supabase ダッシュボード、GCP Monitoring
- デプロイ: CI/CD（GitHub Actions）

---

## 10. 制約事項

### 10.1 技術的制約

- OpenAI API レート制限（TPM, RPM）
- Cloud Run 実行時間制限（最大60分、推奨10分以内）
- Supabase 無料プランの制約（Pro プランで解消）
- GCS Signed URL の有効期限（最大7日間）

### 10.2 機能的制約

- 多人数通話の話者分離は未対応（Whisper API の制限）
- リアルタイム文字起こし未対応（バッチ処理のみ）
- 動画通話は未対応（音声のみ）

### 10.3 データ制約

- 音声ファイル: 最大300MB（Zoom Phone の制限）
- 文字起こし: 最大80,000文字
- 学習資料: 1ファイル最大10MB

---

## 付録A: API エンドポイント設計

### A.1 認証

- `POST /api/auth/login` - ログイン
- `POST /api/auth/logout` - ログアウト
- `GET /api/auth/user` - ユーザー情報取得

### A.2 プロジェクト管理

- `GET /api/projects` - プロジェクト一覧
- `POST /api/projects` - プロジェクト作成
- `PUT /api/projects/:id` - プロジェクト更新
- `DELETE /api/projects/:id` - プロジェクト削除
- `GET /api/projects/:id/members` - メンバー一覧
- `POST /api/projects/:id/members` - メンバー追加
- `DELETE /api/projects/:id/members/:userId` - メンバー削除

### A.3 プロンプト管理

- `GET /api/prompts?projectId=xxx&type=connected` - プロンプト取得
- `POST /api/prompts` - プロンプト作成
- `PUT /api/prompts/:id` - プロンプト更新
- `GET /api/prompts/:id/history` - 変更履歴取得
- `POST /api/prompts/generate` - AIプロンプト生成

### A.4 トークスクリプト管理

- `GET /api/talk-scripts?projectId=xxx` - トークスクリプト取得
- `POST /api/talk-scripts` - トークスクリプト作成
- `PUT /api/talk-scripts/:id` - トークスクリプト更新
- `DELETE /api/talk-scripts/:id` - トークスクリプト削除
- `GET /api/talk-scripts/:id/history` - 変更履歴取得
- `POST /api/talk-scripts/import-pdf` - PDF取り込み
- `POST /api/talk-scripts/:id/hearing-items` - ヒアリング項目追加
- `PUT /api/talk-scripts/hearing-items/:itemId` - ヒアリング項目更新
- `DELETE /api/talk-scripts/hearing-items/:itemId` - ヒアリング項目削除

### A.5 学習資料管理

- `GET /api/learning-materials?projectId=xxx` - 学習資料一覧
- `POST /api/learning-materials` - 学習資料アップロード
- `DELETE /api/learning-materials/:id` - 学習資料削除
- `GET /api/learning-materials/:id/preview` - プレビュー

### A.6 通話データ

- `GET /api/calls` - 通話一覧（フィルタ・ページネーション対応）
- `GET /api/calls/:id` - 通話詳細
- `GET /api/calls/:id/script-analysis` - トークスクリプト一致率分析取得
- `PUT /api/calls/:id/appointment` - アポイント判定更新
- `PUT /api/calls/:id/valid-lead` - 有効リード判定更新
- `GET /api/calls/:id/audio-url` - 音声ファイル Signed URL 取得

### A.7 KPI

- `GET /api/kpi?projectId=xxx&period=daily` - KPI取得
- `GET /api/kpi/ng-reasons?projectId=xxx` - NG理由集計

### A.8 Webhook（Cloud Run）

- `POST /webhook/zoom` - Zoom Webhook 受信

---

## 付録B: UI/UX 設計

### B.1 画面一覧

1. **ログイン画面**
2. **ダッシュボード**（KPI表示）
3. **通話一覧**（フィルタ・検索）
4. **通話詳細**（音声再生、文字起こし、フィードバック、感情分析グラフ）
5. **プロジェクト管理**
6. **プロンプト管理**
7. **トークスクリプト管理**
8. **学習資料管理**
9. **ユーザー管理**（オーナーのみ）
10. **NG理由管理**（オーナーのみ）
11. **設定**

### B.2 ナビゲーション

- サイドバー: ダッシュボード、通話、プロジェクト、設定
- トップバー: ユーザー情報、通知、ログアウト

---

## 付録C: データ移行計画

### C.1 現行システムからの移行

1. Google Drive の音声ファイル → GCS へ移行
2. スプレッドシートの通話データ → Supabase へ移行
3. スプレッドシートのプロンプト → Supabase へ移行
4. トークスクリプト → 新規作成（現行システムに存在しないため、各プロジェクトで新規作成）
5. スプレッドシートのユーザー管理 → Supabase へ移行

### C.2 移行スクリプト

- Google Drive API で音声ファイルを取得 → GCS へアップロード
- Google Sheets API でデータ取得 → Supabase へインポート

---

**以上**
