# M1.5 統合テスト結果

**テスト実施日**: 2025-11-04
**テスト対象**: 基本的な通話処理フロー（M1.5）
**テスト結果**: ✅ 成功

---

## テスト概要

Zoom Phone通話のWebhook受信からSupabaseへのデータ保存まで、エンドツーエンドの通話処理フローの統合テストを実施。

---

## テストケース

### テスト1: 通話処理フロー（テスト架電1回目）

**実施時刻**: 2025-11-04 07:37:00 (JST)
**通話ID**: `8c508134-f296-464e-b47b-3a019ef3940f`
**結果**: ❌ 失敗（Supabase URL不一致）

**発見した問題**:

1. Cloud RunのSupabase URL環境変数が旧プロジェクトのURLになっていた
   - 誤: `https://vpppuxsbnuwzjwtcfbks.supabase.co`
   - 正: `https://pmaxsjrfcqrhxspszens.supabase.co`
2. テーブルカラム名がスキーマ定義と不一致
   - `audio_file_path` → `audio_url`
   - `transcript_file_path` → `transcript_url`
   - `duration` → `duration_seconds`
   - `called_number` → `callee_number`
   - 不足: `zoom_recording_id`, `direction`, `status_confidence`

**処理詳細**:

- ✅ Webhook受信
- ✅ 音声ダウンロード (486,720 bytes)
- ✅ GCSアップロード
- ✅ Whisper API文字起こし (251文字)
- ✅ GPT-5-mini ステータス検出 (reception, 90% confidence)
- ❌ Supabase保存失敗 (`TypeError: fetch failed`)

---

### テスト2: 通話処理フロー（テスト架電2回目 - 修正後）

**実施時刻**: 2025-11-04 07:51:00 (JST)
**通話ID**: `ad06a24c-f02b-40a7-a364-816c2f06b01c`
**結果**: ✅ 成功

**修正内容**:

1. Cloud Run環境変数更新

   ```bash
   gcloud run services update backend-processor \
     --region us-central1 \
     --update-env-vars SUPABASE_URL=https://pmaxsjrfcqrhxspszens.supabase.co
   ```

2. コード修正 (`backend/processor/src/processor.ts`)
   - カラム名をスキーマ定義に合わせて修正
   - 不足していたフィールドを追加

3. Cloud Runへ再デプロイ
   - 新リビジョン: `backend-processor-00014-shv`

**処理詳細**:

- ✅ Webhook受信
- ✅ 音声ダウンロード (1,062,144 bytes)
- ✅ GCSアップロード: `gs://zoom-phone-feedback-audio/audio/ad06a24c-f02b-40a7-a364-816c2f06b01c.m4a`
- ✅ Whisper API文字起こし (222文字)
- ✅ 文字起こし保存: `gs://zoom-phone-feedback-audio/transcripts/ad06a24c-f02b-40a7-a364-816c2f06b01c.txt`
- ✅ GPT-5-mini ステータス検出 (no_conversation, 85% confidence)
- ✅ **Supabase保存成功** (Record ID: `fd250516-37da-443a-b5f1-35fda1112ac1`)
- ✅ Slack通知送信
- ✅ 処理完了

**保存されたデータ**:

```json
{
  "id": "fd250516-37da-443a-b5f1-35fda1112ac1",
  "zoom_call_id": "ad06a24c-f02b-40a7-a364-816c2f06b01c",
  "zoom_recording_id": "ad06a24cf02b40a7a364816c2f06b01c",
  "call_time": "2025-11-04T07:51:05",
  "duration_seconds": 66,
  "direction": "outbound",
  "caller_number": "1049",
  "callee_number": "+818037836264",
  "status": "no_conversation",
  "status_confidence": 0.85,
  "audio_url": "audio/ad06a24c-f02b-40a7-a364-816c2f06b01c.m4a",
  "transcript_url": "transcripts/ad06a24c-f02b-40a7-a364-816c2f06b01c.txt"
}
```

**GPT-5-mini判定理由**:

> 「通話時間は66秒あるが、内容は自己紹介と展示会・デモに関する連絡を名目としたテスト通話のみで、具体的な商談や意思決定者とのやり取りが確認できないため。」

---

## テスト環境

### Cloud Run Services

**Zoom Proxy**:

- URL: `https://zoom-proxy-421962770379.asia-northeast1.run.app`
- リビジョン: 最新
- ポート: 8081 (ローカル)

**Backend Processor**:

- URL: `https://backend-processor-421962770379.us-central1.run.app`
- リビジョン: `backend-processor-00014-shv`
- ポート: 8080 (ローカル)

### インフラ

- **GCS Bucket**: `zoom-phone-feedback-audio`
- **Pub/Sub Topic**: `zoom-webhook-topic`
- **Pub/Sub Subscription**: `zoom-webhook-subscription` (Push型)
- **Supabase**: `https://pmaxsjrfcqrhxspszens.supabase.co`

### フロントエンド

- **Development Server**: `http://localhost:7000`
- **Framework**: Next.js 14.2.23

---

## 処理フロー確認

```
1. Zoom Phone通話完了
   ↓
2. Zoom Webhook送信 → Cloud Run Proxy (8081)
   ↓
3. Webhook署名検証 → Cloud Pub/Sub トピック送信
   ↓
4. Cloud Pub/Sub → Backend Processor (8080) Push通知
   ↓
5. Backend Processor処理開始
   ├─ Step 1: Zoom OAuth取得 → 音声ダウンロード → GCS保存
   ├─ Step 2: GCSから音声取得 → Whisper API文字起こし → GCS保存
   ├─ Step 3: GPT-5-mini ステータス検出 (connected/reception/no_conversation)
   ├─ Step 4: Supabaseにメタデータ保存 ✅
   └─ Step 5: Slack通知送信
   ↓
6. 処理完了 ✅
```

---

## 確認事項

### ✅ 成功した項目

1. Zoom Webhook受信・署名検証
2. Cloud Pub/Sub経由のメッセージ配信
3. Zoom OAuth認証・音声ダウンロード
4. GCS音声ファイル保存
5. Whisper API文字起こし (OpenAI API)
6. 文字起こしテキストのGCS保存
7. GPT-5-mini通話状態判定 (OpenAI API)
8. **Supabaseへのデータ保存** ← 今回修正完了
9. Slack通知送信

### ⚠️ 未実装の項目

1. **通話履歴表示UI** - フロントエンドで通話データを表示する画面（Phase 3予定）
2. **フィードバック生成** - GPT-5/GPT-5-miniによるフィードバック生成（Phase 3予定）
3. **トークスクリプト分析** - GPT-5による一致率分析（Phase 3予定）
4. **RAG検索機能** - pgvectorによる学習資料検索（Phase 4予定）
5. **ユニットテスト** - カバレッジ80%以上（Phase 7予定）

---

## 修正内容の詳細

### 1. Supabase URL修正

**ファイル**: Cloud Run環境変数
**変更前**: `SUPABASE_URL=https://vpppuxsbnuwzjwtcfbks.supabase.co`
**変更後**: `SUPABASE_URL=https://pmaxsjrfcqrhxspszens.supabase.co`

### 2. processor.ts修正

**ファイル**: `backend/processor/src/processor.ts` (Line 117-137)

**変更前**:

```typescript
const { data: callRecord, error } = await supabase.from('calls').insert({
  zoom_call_id: callId,
  call_time: new Date(recording.date_time),
  duration: recording.duration, // ❌ 誤: duration
  caller_number: recording.caller_number || null,
  called_number: recording.callee_number || null, // ❌ 誤: called_number
  status: statusResult.status,
  audio_file_path: audioResult.gcsPath, // ❌ 誤: audio_file_path
  transcript_file_path: transcriptPath, // ❌ 誤: transcript_file_path
  transcript_text: transcriptionResult.text, // ❌ スキーマに存在しない
  project_id: null,
  user_id: null,
})
```

**変更後**:

```typescript
const { data: callRecord, error } = await supabase.from('calls').insert({
  zoom_call_id: callId,
  zoom_recording_id: recording.id, // ✅ 追加
  call_time: new Date(recording.date_time),
  duration_seconds: recording.duration, // ✅ 修正
  direction: recording.direction, // ✅ 追加
  caller_number: recording.caller_number || null,
  callee_number: recording.callee_number || null, // ✅ 修正
  status: statusResult.status,
  status_confidence: statusResult.confidence, // ✅ 追加
  audio_url: audioResult.gcsPath, // ✅ 修正
  transcript_url: transcriptPath, // ✅ 修正
  project_id: null,
  user_id: null,
})
```

---

## 結論

**M1.5 (基本的な通話処理フロー) の統合テストは成功しました。**

- Zoom Webhook受信からSupabase保存まで、全ステップが正常に動作することを確認
- 2回のテスト架電を通じて、環境設定とコードの問題を特定・修正
- Cloud Run上でのOpenAI API連携（Whisper, GPT-5-mini）も正常動作
- データベーススキーマとコードの整合性を確保

**次のステップ**:

- Phase 2: M2.2 (プロンプトバージョン管理) の実装
- Phase 3: 通話履歴表示UI、トークスクリプト管理の実装
- ユニットテスト・統合テストの整備

---

**テスト実施者**: Claude Code
**承認**: 深瀬 雅己
**日付**: 2025-11-04
